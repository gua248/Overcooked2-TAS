# 胡闹厨房2 - TAS 工具使用说明

## 所需工具

- Python 3.10
- [BepInEx 5 (x86)](https://github.com/BepInEx/BepInEx/releases)
- [ffmpeg 可执行文件](https://www.gyan.dev/ffmpeg/builds/)



## 功能

本工具包含两个部分：

- 加载到游戏内的 `BepInEx` 插件（`plugin/`）
- 外部的基于 `Python` 的虚拟手柄控制和输入记录器（`controller/`）

### 游戏内插件

#### 安装

将 `plugin/bin/Release/OC2TAS.dll` 和 `ffmpeg.exe` 拷贝到游戏的 `BepInEx/plugins` 文件夹。

#### 功能

- 按 `F9` 暂停 / 恢复游戏，暂停状态下按 `F11` 进入下一帧。
- 按 `F10` 重放同一目录（`BepInEx/plugins`）下的 `replay.json` 脚本。重放结束后为暂停状态。可以在重放过程中按 `F10` 中止重放。重放所需时间与电脑性能有关，与真实时间不一致。
- 按 `F8` 若干次可显示部分游戏数据（坐标、烹饪时间等）。
- 按 `F1` 以同一目录下的 `replay.json` 脚本录制视频，输出目录为 `D:/TAS output/`。可以在录制过程中按 `F1` 中止录制。由于需要进行音视频编码，录制所需时间较长。

#### 编译

你可以修改代码后重新编译。需要将以下依赖项拷贝到 `plugin/lib` 目录下：

- 游戏 `Overcooked2_Data/Managed` 目录下 `Assembly-CSharp.dll`, `UnityEngine.dll`, `UnityEngine.AnimationModule.dll`, `UnityEngine.AudioModule.dll`, `UnityEngine.CoreModule.dll`, `UnityEngine.ImageConversionModule.dll`, `UnityEngine.IMGUIModule.dll`, `UnityEngine.ParticleSystemModule.dll`, `UnityEngine.PhysicsModule.dll`, `UnityEngine.TextRenderingModule.dll`。
- `BepInEx/core` 目录下 `0Harmony20.dll`, `BepInEx.dll`, `BepInEx.Harmony.dll`。

### 虚拟手柄控制和输入记录器

<div align="center">
    <img src="app.png" width="50%" height="50%" />
</div>

#### 安装Python环境和运行

```
pip install -r ./controller/requirements.txt
```

过程中会安装虚拟手柄驱动

```
cd ./controller
python ./controller.py
```

#### 功能

- 运行后创建四个虚拟手柄，数字键 `1` `2` `3` `4` 可切换控制的手柄。
- `w` `a` `s` `d` 控制方向，其他按键可以在 `controller.py` 的 `UIFunc.keymap` 设置（映射到虚拟手柄的 `A` `B` `X` `Y` 键）。另外，回车键映射到 `A` 键，目的是在主菜单添加玩家时避免按空格导致添加键盘玩家。
- 除了上下左右控制的八个角度，其他角度可以在录制时用鼠标滚轮修改 `X`, `Y` 值。⚠️**不要点击输入框，游戏窗口失去焦点会导致手柄输入失效。**
- 按 `F3` 可以切换游玩模式 / 录制模式。在录制模式下，按一次按键对应按下，再按一次对应松开相应按键，方向键类似。
- 在录制模式下，按 `F11` 会记录当前手柄状态，并进入下一帧。下一帧的默认手柄状态与前一帧相同。
- 在录制模式下，按 `F5` 会保存到上一帧为止录制的脚本到 `records/` 目录。切换回游玩模式时也会自动保存。
- 在游玩模式下，按 `F10` 会读取游戏 `BepInEx/plugins` 文件夹下的 `replay.json` 脚本作为历史记录，并从脚本的后一帧开始继续录制。⚠️**需要将 `controller.py` 的 `UIFunc.replay_file_path` 修改为正确的路径。**
- 游戏中有两个重要的冷却时间：拿取 25 帧（0.5 秒）、加速 20 帧（0.4 秒）。为方便录制，在界面的对应按键上设有计数器，其中加速键计数器在每次按下加速键时更新计数，拿取计数器则需要手动按 `left alt` 键更新计数。
- 数字键 `0` 可以暂停 / 恢复程序对键盘输入的响应。

### 脚本格式

<div align="center">
    <img src="script.png" width="50%" height="50%" />
</div>


脚本用 json 格式保存。

> - `author` 为脚本作者，可以在 `controller.py` 的 `UIFunc.author` 设置。
> - `level` 为脚本对应的关卡名，在初次录制时会自动填写。
> - `menu` 为脚本使用的固定菜单。
> - `pickup_flag` 为保存时四个拿起计数器的值，重放（按 `F10`）时会载入计数器。
> - `state` 为脚本内容，记录了每帧每个手柄每个按键的值，`false` 表示按键松开，`true` 表示按键按下，方向值的范围是 [-1, 1]。重放时加速计数器会根据 `state` 内容载入正确的值。



## 录制流程


### 开始录制

1. `python ./controller.py` 运行记录器，之后启动游戏，添加若干虚拟手柄玩家

2. 进入关卡后在关卡准备阶段按 `F9` 暂停，然后按 `F10`，将会生成一个空的脚本 `BepInEx/plugins/replay.json`

3. 编辑该脚本，在 `menu` 中填写固定菜单

   > #### 菜单编号顺序
   > - 如果安装了 UnityExplorer，可以在 `FlowManager` 对象的 `Server*FlowController` 组件 `LevelConfig.m_rounds[*].m_recipes.m_recipes` 字段查看菜单编号顺序。
   > - 也可以随意填写并重放后观察出现的菜单，以确定菜单编号顺序。
   > - ⚠️**请注意所设置菜单的[合法性](https://www.bilibili.com/read/cv11638961)。**

4. 后续录制从重放该空脚本开始


### 重放和继续录制

1. 将需要重放的脚本拷贝到游戏 `BepInEx/plugins` 文件夹，并重命名为 `replay.json`

2. 编辑脚本，例如删去最后需要重新录制的若干帧或修改某一按键的值（⚠️**注意保证脚本格式正确，不要有多余的逗号**）

3. 进入关卡后在关卡准备阶段按 `F9` 暂停，然后按 `F10` 重放（记录器会自动切换到录制模式并读取脚本作为历史记录）

4. 重放结束后即可继续录制，每一帧按键输入完成后按 `F11` 进入下一帧

   > #### 部分重新录制
   >
   > 有时只想重新录制某一玩家的最后若干帧，此时不需要删去所有玩家的最后若干帧内容，可以使用部分重新录制。
   >
   > 1. 在脚本文件中找到需要重录的起始帧，将需要重录的玩家的第一个按键值改为 `null`
   > 2. 重放脚本
   > 3. ⚠️**重放结束后，额外按一次 `F11` 载入重放后第一帧的非重录玩家的手柄状态（这一次按 `F11` 游戏不会前进一帧）**
   > 4. 继续录制，之后的每一帧会从脚本自动载入非重录玩家的手柄状态
   > 5. 超出脚本范围后，回到正常录制状态

5. 中止录制直接按 `F3` 和 `F9` 回到正常游玩状态即可，脚本自动保存在 `records` 目录

### 最终视频录制

进入关卡后在关卡准备阶段按 `F9` 暂停，然后按 `F1` 即以 `replay.json` 脚本录制视频，输出目录为 `D:/TAS output/`。

### 位置修正

在大多数情况下，重放得到的结果是唯一确定的。然而由于 Unity 引擎的物理计算并不是完全确定性的，在某些情况下重放时人物和物品坐标会有微小偏差，累积起来可能导致错误的结果，例如上下楼梯、未吸附到台面的物品。位置修正可以用来在这些情况下保证重放的确定性。在脚本中添加形如

```json
  "position_correction": 
  [
    ["Player 4", 2066, 9.4302, 0.0000, 10.6001],
    ["Player 3", 2170, 2.2029, 0.0000, 10.6480],
    ...
  ],
```

的键值对，其中每条位置修正指令的组成是 `[对象名, 帧位置, x, y, z]`，意味着在该帧将该对象坐标置为 `(x, y, z)`。插件支持按 `F8` 显示 / 隐藏玩家的坐标信息。

> - ⚠️**这个功能一定程度上违背了 TAS 不能修改游戏原有逻辑的原则，请谨慎使用。在不得不使用的情况下，请确保每条位置修正指令都来自于某次重放的结果。**
> - ⚠️**注意位置修正指令只修改位置坐标，当对象加减速或变向时速度等其他运动学属性也会受不确定性影响。**
> - 重放时若原本坐标与位置修正指令坐标已经相同，则不会进行修正。输出日志（`BepInEx/LogOutput.log`）中包含位置修正指令的执行情况。**应当保证每条指令都至少有一次不被执行。**
>
> - 对于人物以外的游戏对象，需要使用 `UnityExplorer` 等工具查看对象名和坐标。



## 提示

- **录制的固定帧率为 50 帧。**

- **为使记录器窗口位于全屏游戏之上，需要给游戏[添加启动选项](https://www.bilibili.com/video/BV12M411W75T) `-popupwindow`。**

- 一些按键在按下后立即有反馈，如拿放，切洗，投掷瞄准，投掷。加速键需要步进一帧才生效，如果发现加速键按错了，在步进一帧前修改回松开即可。

- 一些操作不能在同一帧进行，包括但不限于：

  - 玩家 A 放下物品，然后玩家 B 抬起该物品
  - 玩家 A 切换酱，然后玩家 B 接酱
  - 松开交互键投掷出物品，然后拿起另一物品

  以下操作可以在同一帧进行：

  - 放下物品，然后切洗
  - 拿起物品，然后投掷瞄准
  - 拿放物品，然后加速或改变方向

  可以立即与上一帧发生状态变化的物品交互，如抬起刚切好的材料、接出刚熟的锅、放下刚接到的食材。

- 避免包含歧义的操作，包括但不限于：

  - 180度转身，例如为面向 (1.0, 1.0) 的角色输入方向 (-1.0, -1.0)（正上对正下，正左对正右不具有这种歧义）
  - 恰好在两个桌台判定的分界处拿放，例如位于并排桌台的中垂线上，或位于直角桌台的拐角处并面朝45度方向

- 为方便最终视频录制，请在关卡结束后继续录制脚本，直到希望视频结束的时间。



## 已知错误

- 录制时偶尔游戏会从虚拟手柄读到错误的输入，导致无故扔出或放下物品。
- 偶尔会出现关闭 `controller.py` 时驱动未能正确移除虚拟手柄的情况，导致在下一次运行时报错。此时需要重启电脑（系统可能会蓝屏报错并修复驱动）。
- 开启 `BepInEx` 的控制台可能会导致无法以手柄进入游戏，需要在配置文件 `BepInEx/config/BepInEx.cfg` 中 `[Logging.Console]` 设置值 `Enabled = false`。



## 关于 TAS

@hpmv 实现了另一种[基于高阶指令的 TAS 框架](https://github.com/hpmv/overcooked-supercharged)，关于胡闹厨房 TAS 的详细介绍可以阅读[他的文档](https://hpmv.dev/docs/tas/)。

本框架基于原始按键输入，这是最简单、最底层的实现方法。遗憾的是，由于 Unity 游戏具有动态逻辑帧率，我们不得不对原始游戏代码逻辑进行一些修改，以下是主要的几处修改：

- 固定帧率 50，即 `Time.captureFramerate = 50`。
- 假设游戏逻辑帧率无穷大。在原始游戏代码逻辑中，即使是本地联机，一些应当立即生效的事件也有 1~2 逻辑帧的延迟。我们不希望频繁在固定帧率的每秒 50 帧中浪费这些延迟。由于逻辑帧率一般 > 200 >> 50，我们假设游戏逻辑帧率无穷大并将这些事件的延迟抹去。
- 在不得已的情况下，使用位置修正指令。

**欢迎将利用本工具制作的 TAS 脚本提交到这个 github 仓库。**



## 开发辅助工具

- [dnSpy](https://github.com/dnSpy/dnSpy)

  > 打开游戏目录下 `Overcooked2_Data/Managed/Assembly-CSharp.dll` 可以查看和修改游戏代码

- [UnityExplorer](https://github.com/sinai-dev/UnityExplorer)

  > 用来查看游戏中的游戏对象和组件


